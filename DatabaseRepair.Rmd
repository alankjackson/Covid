---
title: "DatabaseRepair"
author: "Alan Jackson"
date: "3/14/2020"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)

knitr::opts_chunk$set(echo = TRUE)
```

##  delete and save last days data


```{r del}

path <- "/home/ajackson/Dropbox/Rprojects/Covid/"

foo <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")

#indicies <- tail(which(foo$County=="Total"),2)

#foo <- foo[1:indicies[1],]
#foo <- foo[1:71,]

foo <- foo[1:1040,]

# Save an accumulated file in case of a failure
#saveRDS(foo,paste0("/home/ajackson/Dropbox/Rprojects/Covid/",lubridate::today(),"_Covid.rds"))
# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Covid.rds")

#############   tests
foo <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Testing.rds")
foo <- foo[1:11,]

# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Testing.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Testing.rds")

#############   deaths
foo <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Deaths.rds")

foo <- foo[1:10,]

# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Deaths.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Deaths.rds")



```

##  Delete Total field

```{r delete total}

path <- "/home/ajackson/Dropbox/Rprojects/Covid/"

foo <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")

foo <- foo %>% filter(County!="Total")

# Save an accumulated file in case of a failure
saveRDS(foo,paste0("/home/ajackson/Dropbox/Rprojects/Covid/",lubridate::today(),"_Covid.rds"))
# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Covid.rds")



```

##  Add Deaths field

```{r delete total}

path <- "/home/ajackson/Dropbox/Rprojects/Covid/"

foo <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")

foo <- foo %>% mutate(Deaths="-")

# Save an accumulated file in case of a failure
saveRDS(foo,paste0("/home/ajackson/Dropbox/Rprojects/Covid/",lubridate::today(),"_Covid.rds"))
# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Covid.rds")



```

##  Fix Covid

```{r deathdata}

path <- "/home/ajackson/Dropbox/Rprojects/Covid/"

foo <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")

foo <- slice(foo,-11455:-11708)

saveRDS(foo ,paste0("/home/ajackson/Dropbox/Rprojects/Covid/",lubridate::today(),"_deaths.rds"))
# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Covid.rds")
```

##  Add LastUpdate field

```{r deathdata}

path <- "/home/ajackson/Dropbox/Rprojects/Covid/"

foo <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")

foo <- foo %>% 
  mutate(LastUpdate=Date) %>% 
  mutate(Deaths=str_replace(Deaths,"-", "na")) %>% 
  mutate(Deaths=as.numeric(Deaths)) %>% 
  replace_na(list(Count_ = 0, Deaths=0))

hour(foo$LastUpdate) <- 11

foo$LastUpdate <- as.character(foo$LastUpdate)


# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Covid.rds")
```

## Subtract one day from dates - I have retrieval date, not actual date

```{r shift dates}

path <- "/home/ajackson/Dropbox/Rprojects/Covid/"

foo <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")
foo <- foo %>% 
  mutate(Date=Date-1)
# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Covid.rds")

#    deaths
foo <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Deaths.rds")

foo <- foo %>% 
  mutate(Date=if_else(Date>ymd("2020-03-22"),Date-1, Date))

# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Deaths.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Deaths.rds")

# Tests
foo <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Testing.rds")
foo <- foo %>% 
  mutate(Date=Date-1)

# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Testing.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Testing.rds")

```


## Add NYT data to standard dataset to flesh out time series of deaths by county

```{r death by county}

path <- "/home/ajackson/Dropbox/Rprojects/Covid/NYTdata/covid-19-data-master/"

df <- read_csv(paste0(path, "us-counties.csv")) %>% 
  filter(state=="Texas") %>% 
  mutate(NYT_deaths=deaths, NYT_cases=cases) %>% 
  select(Date=date, County=county, NYT_deaths, NYT_cases)

foo <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")

foobar <- left_join(foo, df, by=c("Date", "County"))

#foobar <- foobar %>% mutate(Deaths=pmax(Deaths, NYT_deaths,na.rm=TRUE ))
mask <- foobar$Date==ymd("2020-03-28")
foobar[mask,]$Cases <- pmax(foobar[mask,]$Cases, foobar[mask,]$NYT_cases)

foobar <- foobar %>% select(-NYT_deaths, -NYT_cases)
# Save the real file for later use
saveRDS(foobar,"/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")
# Also save to mirror site
saveRDS(foobar,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Covid.rds")
```

## Remove NYT data columns from dataset

```{r clean up NYT}

path <- "/home/ajackson/Dropbox/Rprojects/Covid/"

foo <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")

foo <- foo %>% select(-NYT_deaths, -NYT_cases)
# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Covid.rds")
```

## Make cases monotonic

```{r monotonic}

# if number of cases drop per county, reduce preceeding numbers

path <- "/home/ajackson/Dropbox/Rprojects/Covid/"

foo <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")

foo2 <- foo %>% 
  group_by(County) %>% 
  mutate(delta=Cases-lag(Cases))


```

## Fix missing tests

```{r missing tests}
#############   tests
foo <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Testing.rds")
foo <- foo[11:14,]

foo <- bind_rows(`2020-04-22_Testing`, foo)

foo %>% unique() -> foo

# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Testing.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Testing.rds")

```

##  Create a separate county population file to be read in

```{r}

inpath <- "/home/ajackson/Dropbox/Rprojects/Datasets"
utpath <- "/home/ajackson/Dropbox/Rprojects/Datasets/Archive"

df <- readxl::read_excel(paste0(inpath,"/","Census_July1_2019_TexasCountyPop.xlsx"))

df <- df %>% 
  rename(County=1, Census=13) %>% 
  filter(grepl("County,",County)) %>% 
  mutate(County=str_remove(County,"[.]")) %>% 
  mutate(County=str_remove(County," County, Texas")) %>% 
  select(County, Population=Census)

saveRDS(df, paste0(utpath,"/","Census_July1_2019_TexasCountyPop.rds"))

```


##   add dates to prison data

```{r add prison dates}

# Read in the old data
prisons <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Prisons.rds")

dates <- as_date(ymd("2020-04-26"):ymd("2020-05-06"))

foo <- prisons %>% 
  mutate(id = as.numeric(rownames(.))) %>% # give row an id so we don't lose ordering
  group_by(Unit) %>% 
    arrange(id) %>% 
    mutate(Date=dates) %>% 
  ungroup() %>% 
  select(-id)
    
# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Prisons.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Prisons.rds")


```

##  Replace data for May 8

```{r replace May 8}

inpath <- "/home/ajackson/Dropbox/Rprojects/Covid/TexasDataXcel/"
utpath <- "/home/ajackson/Dropbox/Rprojects/Covid/"
path <- "/home/ajackson/Dropbox/Rprojects/Covid/"

foo <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")

#         fix cases
df <- readxl::read_excel(paste0(inpath,"County_Case_Data_2020-05-10.xlsx"))

df <- df %>% 
  rename(County=1, Cases=65) %>% 
  select(County, Cases)
  
df <- df[3:256,]

foo[foo$Date==ymd("2020-05-08"),]$Cases <- as.numeric(df$Cases)

# Fix deaths

df <- readxl::read_excel(paste0(inpath,"Deaths_by_County_2020-05-10.xlsx"))

df <- df %>% 
  rename(County=1, Deaths=68) %>% 
  select(County, Deaths)
  
df <- df[3:256,]

foo[foo$Date==ymd("2020-05-08"),]$Deaths <- as.numeric(df$Deaths)

#############   doesn't really match up. Let's just do a fuill replacement
#############   with the spreadsheet data




# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Covid.rds")
```

## Replace Covid file from beginning with spreadsheet

```{r new file}

inpath <- "/home/ajackson/Dropbox/Rprojects/Covid/TexasDataXcel/"
utpath <- "/home/ajackson/Dropbox/Rprojects/Covid/"

#         get cases
df <- readxl::read_excel(paste0(inpath,"County_Case_Data_2020-06-13.xlsx"))

# No data for March 14

lastdate <- ncol(df)-11

my_colnames <- c(
                 ymd("2020-03-10"),  
                 ymd("2020-03-11"),  
                 ymd("2020-03-12"),  
                 ymd("2020-03-13"),  
                 ymd("2020-03-15")+0:lastdate)

my_colnames <- my_colnames %>% 
                 format('%Y-%m-%d')
my_colnames <- c("County", my_colnames)


my_columns <- c(1, 7:ncol(df))

df <- df %>% 
  rename_at(my_columns,~ my_colnames)
  
df <- df[3:256,]
df <- df[-c(2:6)]

df <- df %>% pivot_longer(-County, names_to="Date", values_to="Cases")

foo <- df %>% mutate(Cases=as.numeric(Cases))

# get deaths

df <- readxl::read_excel(paste0(inpath,"Deaths_by_County_2020-06-13.xlsx"))

my_columns <- c(1, 9:12, 14:ncol(df))

df <- df %>% 
  rename_at(my_columns,~ my_colnames)

df <- df[3:256,]
df <- df[-c(2:8, 13)]

df <- df %>% pivot_longer(-County, names_to="Date", values_to="Deaths")

foo$Deaths <- df$Deaths

foo$Cases <- as.numeric(foo$Cases)
foo$Deaths <- as.numeric(foo$Deaths)
foo$Date <- ymd(foo$Date)

# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Covid.rds")

```
## \r\n added to a county name

```{r bad county name}

path <- "/home/ajackson/Dropbox/Rprojects/Covid/"

foobar <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")

foobar <- foobar %>% 
  mutate(County=str_replace_all(County, "[\r\n]" , "")) %>%  
  mutate(County=str_replace(County, "SanAugustine" , "San Augustine"))# %>%  
#  select(-LastUpdate)

# Save the real file for later use
saveRDS(foobar,"/home/ajackson/Dropbox/Rprojects/Covid/Covid.rds")
# Also save to mirror site
saveRDS(foobar,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Covid.rds")
```

##  Fix bad tests

```{r bad tests}

# Read in the old data
TestingData <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Testing.rds")

# back up dates one day
TestingData$Date <- TestingData$Date+1

# add missing day
testing_status <- tribble(
  ~Private, ~Public, ~Total, ~Date,
  NA,       NA,      "330300", ymd("2020-04-30")
)   
TestingData <- TestingData %>% 
  bind_rows(testing_status) %>%
  arrange(Date)

TestingData <- TestingData[c(1:56,58:59),]

TestingData[52:58,]$Total <- c("489294", "513978",  "525697",  
                               "538172", "587431", "623284", "645992") 

# Save an accumulated file in case of a failure
saveRDS(TestingData,paste0("/home/ajackson/Dropbox/Rprojects/Covid/",lubridate::today(),"_Testing.rds"))
# Save the real file for later use
saveRDS(TestingData,"/home/ajackson/Dropbox/Rprojects/Covid/Testing.rds")
# Also save to mirror site
saveRDS(TestingData,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Testing.rds")




```

##  prison data not updated - fix it

```{r no update prisons}


# Read in the old data
prisons <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Prisons.rds")

foo <- prisons %>% 
  filter(Date<lubridate::ymd("2020-05-24"))
    
# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Prisons.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Prisons.rds")


```



##  prison data doubled - fix it

```{r double prisons}


# Read in the old data
prisons <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Prisons.rds")

newdate <- lubridate::ymd("2020-05-19")

foo <- prisons %>% 
  distinct() %>% # eliminate complete duplicates
  mutate(id = as.numeric(rownames(.))) %>% # give row an id so we don't lose ordering
  group_by(Unit, Date) %>% 
    arrange(id) %>% 
    mutate(Index=1:n()) %>% 
  ungroup() %>% 
  mutate(Date=if_else((Index==2)&(Date==lubridate::ymd("2020-05-18")), newdate, Date)) %>% 
  arrange(id) %>% 
  distinct(Unit, Date, .keep_all = TRUE) %>% 
  select(-id, -Index)
    
# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Prisons.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Prisons.rds")


```



##  prison data bad date - fix it

```{r bad date prisons}


# Read in the old data
prisons <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Prisons.rds")

newdate <- lubridate::ymd("2020-05-21")

foo <- prisons %>% 
  distinct() %>% # eliminate complete duplicates
  mutate(id = as.numeric(rownames(.))) %>% # give row an id so we don't lose ordering
  group_by(Unit, Date) %>% 
    arrange(id) %>% 
    mutate(Index=1:n()) %>% 
  ungroup() %>% 
  mutate(Date=if_else((Index==2)&(Date==lubridate::ymd("2020-05-20")), newdate, Date)) %>% 
  arrange(id) %>% 
  distinct(Unit, Date, .keep_all = TRUE) %>% 
  select(-id, -Index)
    
# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Prisons.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Prisons.rds")


```

##   Prison data switched test pending to recovered

```{r recovered}


# Read in the old data
prisons <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Prisons.rds")

prisons %>% 
  filter(Date>lubridate::ymd("2020-05-15")) %>% 
#ggplot(aes(x=Date, y=Positive_Tests, color=Unit)) +
ggplot(aes(x=Date, y=Pending_Tests, color=Unit)) +
  geom_line() + 
  theme(legend.position = "none") 

#   May 21 things changed.

foo <- prisons %>% 
  mutate(Recovered=if_else(Date>=lubridate::ymd("2020-05-21"), Pending_Tests, 0L)) %>% 
  mutate(Pending_Tests=if_else(Date>=lubridate::ymd("2020-05-21"), 0L, Pending_Tests))

    
# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Prisons.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Prisons.rds")


```

##  Prison field missing became na

```{r fix prison NA}

# Read in the old data
prisons <- readRDS("/home/ajackson/Dropbox/Rprojects/Covid/Prisons.rds")

foo <- prisons %>% 
    replace_na(list("Recovered"=0, "Positive_Tests"=0))

# Save the real file for later use
saveRDS(foo,"/home/ajackson/Dropbox/Rprojects/Covid/Prisons.rds")
# Also save to mirror site
saveRDS(foo,"/home/ajackson/Dropbox/mirrors/ajackson/Covid/Prisons.rds")



```

##  fix a day wrong in main file

```{r bad day}

DataLocation <- "/home/ajackson/Dropbox/Rprojects/Covid/"

#   Case data
DF <- readRDS(paste0(DataLocation, "Covid.rds"))

DF[DF$Date=="2020-06-11",]$Cases <- DF[DF$Date=="2020-06-12",]$Cases
DF[DF$Date=="2020-06-11",]$Deaths <- DF[DF$Date=="2020-06-12",]$Deaths

DF <- DF %>% filter(Date!="2020-06-12")

saveRDS(DF, paste0(DataLocation, "Covid.rds"))


```

## Add in prison data from June 10-14

```{r fix prison June data}

# Read in the old data

path <- "/home/ajackson/Dropbox/Rprojects/Covid/DailyBackups/"

filenames <- lubridate::ymd("2020-05-29")+(0:3)
filenames <- c(filenames, lubridate::ymd("2020-06-04")+(0:10))

embers <- c("195", "202", "202", "202", "202", "202", "202", "202", "202", "202",
            "199", "199", "199", "199", "199")

for (filename in filenames) {
  filename <- lubridate::as_date(filename)
  print(paste("---->", filename))
  parsed_pagesource <- readRDS(paste0(path, as.character(filename), "_ParsedPagePrisons.rds"))
  
  #---------------------------------------------------------------------
  #   Extract prison info
  #---------------------------------------------------------------------
  
  # Select a unit to Zoom on Map
  result <- xml2::read_html(parsed_pagesource) %>%
    # select out the part of the page you want to capture
    rvest::html_nodes(xpath='//*[@id="ember199"]') %>%
    # convert it to a really long string, getting rid of html
    rvest::html_text() %>% 
    # there are a lot of carriage returns in there, let's clean them out
    str_replace_all("\n"," ") %>% 
    # Split string on long strings of spaces, returning a list
    str_split("  +")
  
   
  # get rid of title and extra line at end
  result <- result[[1]][3:(length(result[[1]])-1)]
  
  # every other element of list is a Unit, so let's combine the Unit name
  # with the table it used to head, to get the first iteration of a data frame
  res <- cbind.data.frame(split(result, 
                                rep(1:2, times=length(result)/2)), 
                          stringsAsFactors=F)
  #assign some better names
  names(res) <- c("Unit", "foo") 
  
  res <- res %>% 
    # add dash after numbers for later splitting
    mutate(foo=str_replace_all(foo, "(\\d) ", "\\1 -")) %>% 
    # remove all whitespace, some are tabs
    mutate(foo=str_remove_all(foo, "\\s*")) %>% 
    # remove commas from numbers
    mutate(foo=str_remove_all(foo, ",")) %>% 
    # split the field into 12 pieces
    separate(foo, letters[1:12], sep="-") %>% 
    # select out the numeric fields
    select(Unit, b,d,f,h,j,l) %>% 
    # make them numeric
    mutate_at(c("b","d","f","h","j","l"), as.numeric)
  
  # give every field a bright, shiny new name
  names(res) <- c("Unit", 
                  "Offender Active Cases",
                  "Offender Recovered",
                  "Employee Active Cases",
                  "Employee Recovered",
                  "Medical Restriction",
                  "Medical Isolation")
  
  
  # add a field with date
  res <- res %>% mutate(Date=filename) 
  
  saveRDS(res ,paste0("/home/ajackson/Dropbox/Rprojects/Covid/",as.character(filename),"_Prisons_2.rds"))
  
}

# Combine all daily of the new format into one file

files <- dir(pattern = "*_Prisons_2.rds")

prison <- files %>% 
  map(read_rds) %>% 
  reduce(rbind)

prison <- prison %>% replace(is.na(.), 0)

saveRDS(prison ,paste0("/home/ajackson/Dropbox/Rprojects/Covid/_Prisons_2.rds"))
  

```




